<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Retrieve YouTube views count with youtubeDL, JQ, and a Docker container</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Slab:wght@800&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/comic-mono@0.0.1/index.css rel=stylesheet><link rel=stylesheet href=/css/style.css></head><body><header><div><a href=https://glaforge.github.io/>‚ùØ Guillaume Laforge</a><nav><ul><li><a href=/>BLOG</a></li><li><a href=/talks>TALKS</a></li><li><a href=/about>ABOUT</a></li><li><a href=/contact>CONTACT</a></li></ul></nav></div></header><main><article><h1>Retrieve YouTube views count with youtubeDL, JQ, and a Docker container</h1><time datetime=2022-10-26T14:53:39>üìÖ 2022-10-26 üïë 14:53</time><div class=author>üñã by Guillaume Laforge</div><div class=tags><a href=/tags/youtube>youtube</a>
<a href=/tags/advocacy>advocacy</a>
<a href=/tags/docker>docker</a>
<a href=/tags/containers>containers</a>
<a href=/tags/jq>jq</a></div><div><p>I wanted to track the number of views, and also likes, of some YouTube videos I was featured in.
For example, when I present a talk at a conference, often the video becomes available at a later time, and I&rsquo;m not the owner of the channel or video.
At first, I wanted to use the <a href=https://developers.google.com/youtube/v3>YouTube Data API</a>,
but I had the impression that I could only see the stats of videos or channels I own,
however I think I might be wrong, and should probably revisit this approach later on.</p><p>My first intuition was to just scrape the web page of the video, but it&rsquo;s a gobbledygook of JavaScript,
and I couldn&rsquo;t really find an easy way to consistently get the numbers in that sea of compressed JavaScript.
That&rsquo;s when I remembered about the <a href=https://youtube-dl.org/>youtube-dl project</a>.
Some people think of this project as a way to download videos to watch offline, but it&rsquo;s also a useful tool that offers lots of metadata about the videos.
You can actually even use the project without downloading videos at all, but just fetching the metadata.</p><p>For example, if I want to get the video metadata, without downloading, I can launch the following command, after having installed the tool locally:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>youtube-dl -j -s https://www.youtube.com/watch?v<span style=color:#666>=</span>xJi6pldZnsw
</span></span></code></pre></div><p>The <code>-s</code> flag is equivalent to <code>--simulate</code> which doesn&rsquo;t download anything on disk.</p><p>And the <code>-j</code> flag is the short version of <code>--dump-json</code> which returns a big JSON file with lots of metadata, including the view count,
but also things like links to transcripts in various languages, chapters, creator, duration, episode number, and so on and so forth.</p><p>Now, I&rsquo;m only interested in view counts, likes, dislikes.
So I&rsquo;m using <a href=https://stedolan.github.io/jq/>jq</a> to filter the big JSON payload, and create a resulting JSON document with just the fields I want.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>jq <span style=color:#4070a0>&#39;{&#34;id&#34;:.id,&#34;title&#34;:.title,&#34;views&#34;:.view_count,&#34;likes&#34;:(.like_count // 0), &#34;dislikes&#34;:(.dislike_count // 0)}&#39;</span>
</span></span></code></pre></div><p>This long command is creating a JSON structure as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span> <span style=color:#062873;font-weight:700>&#34;id&#34;</span>: <span style=color:#4070a0>&#34;xJi6pldZnsw&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#062873;font-weight:700>&#34;title&#34;</span>: <span style=color:#4070a0>&#34;Reuse old smartphones to monitor 3D prints, with WebRTC, WebSockets and Serverless by G. Laforge&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#062873;font-weight:700>&#34;views&#34;</span>: <span style=color:#40a070>172</span>,
</span></span><span style=display:flex><span> <span style=color:#062873;font-weight:700>&#34;likes&#34;</span>: <span style=color:#40a070>6</span>,
</span></span><span style=display:flex><span> <span style=color:#062873;font-weight:700>&#34;dislikes&#34;</span>: <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>.id</code>, <code>.title</code>, <code>.view_count</code>, etc, are searching for that particular key in the big JSON documentation.
The // 0 notation is to avoid null values and return 0 if there&rsquo;s no key or if the value associated with the key is null.
So I always get a number &mdash; although I noticed that sometimes, the likes are not always properly accounted for, but I haven&rsquo;t figured out why.</p><p>So far so good&mldr; but if you pass a URL of a video with a playlist, or if you pass a playlist URL, it will fetch all the metadata for all the videos.
This is actually useful: you can even create your own playlists for the videos you want to track.
There&rsquo;s one odd thing happening though when using youtube-dl with such URLs: it will output a JSON document per line for each video.
It&rsquo;s not returning an array of those documents. So I found a nice trick with jq to always put the results within an array, whether you pass a URL for a single video, or a video with a playlist:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚Äã‚Äãjq -n <span style=color:#4070a0>&#39;[inputs]&#39;</span>
</span></span></code></pre></div><p>So I&rsquo;m piping the youtube-dl command, the first and second jq commands.</p><p>Rather than installing those tools locally, I decided to containerize my magic commands.</p><p>Let me first show you the whole Dockerfile:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#007020;font-weight:700>FROM</span><span style=color:#4070a0> ubuntu:latest\</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#007020;font-weight:700>RUN</span> apt-get update <span style=color:#666>&amp;&amp;</span> apt-get -y install wget <span style=color:#4070a0;font-weight:700>\\</span>
</span></span><span style=display:flex><span>¬† ¬† <span style=color:#666>&amp;&amp;</span> wget https://yt-dl.org/latest/youtube-dl -O /usr/local/bin/youtube-dl <span style=color:#4070a0;font-weight:700>\\</span>
</span></span><span style=display:flex><span>¬† ¬† <span style=color:#666>&amp;&amp;</span> chmod a+rx /usr/local/bin/youtube-dl <span style=color:#4070a0;font-weight:700>\\</span>
</span></span><span style=display:flex><span>¬† ¬† <span style=color:#666>&amp;&amp;</span> apt-get -y install python3-pip jq <span style=color:#4070a0;font-weight:700>\\</span>
</span></span><span style=display:flex><span>¬† ¬† <span style=color:#666>&amp;&amp;</span> pip3 install --upgrade youtube-dl<span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>COPY ./launch-yt-dl.sh /<span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>RUN chmod +x /launch-yt-dl.sh<span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>ENTRYPOINT <span style=color:#666>[</span><span style=color:#4070a0>&#34;./launch-yt-dl.sh&#34;</span><span style=color:#666>]</span><span>
</span></span></span></code></pre></div><p>And also this bash script mentioned in the Dockerfile:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#007020>#!/bin/bash\
</span></span></span><span style=display:flex><span><span style=color:#007020></span>youtube-dl -j -s -- <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$@</span><span style=color:#4070a0>&#34;</span> | jq <span style=color:#4070a0>&#39;{&#34;id&#34;:.id,&#34;title&#34;:.title,&#34;views&#34;:.view_count,&#34;likes&#34;:(.like_count // 0), &#34;dislikes&#34;:(.dislike_count // 0)}&#39;</span> | jq -n <span style=color:#4070a0>&#39;[inputs]&#39;</span>
</span></span></code></pre></div><p>I went with the latest ubuntu image. I ran some apt-get commands to install wget to download the latest youtube-dl release, Python 3&rsquo;s pip to upgrade youtube-dl.
There&rsquo;s no recent apt module for youtube-dl, hence why we have those steps together.</p><p>What&rsquo;s more interesting is why I don&rsquo;t have the youtube-dl and jq commands in the Dockerfile directly, but instead in a dedicated bash script.
Initially I had an ENTRYPOINT that pointed at youtube-dl, so that arguments passed to the docker run command would be passed as arguments of that entrypoint.
However, after those commands, I still have to pipe with my jq commands. And I couldn&rsquo;t find how to do so with ENTRYPOINT and CMD.
When raising the problem on <a href=https://twitter.com/glaforge/status/1584800385256280064>twitter</a>,
my friends <a href=https://twitter.com/glours/status/1584810960136683521>Guillaume Lours</a> and <a href=https://twitter.com/cfurmaniak/status/1584845647647506432>Christophe Furmaniak</a> pointed me in the right direction with this idea of passing through a script.</p><p>So I use the <code>$@</code> bash shortcut, which expands as arguments <code>$1 $2 $3</code>, etc. in case there are several videos passed as arguments.
I have the jq pipes after that shortcut.
But for my <code>ENTRYPOINT</code>, it&rsquo;s fine, the args are passed directly to it, and it&rsquo;s that intermediary script that weaves the args in my longer command.</p><p>Next, I just need to build my Docker container:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build . -t yt-video-stat
</span></span></code></pre></div><p>And then run it:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -it yt-video-stat <span style=color:#4070a0>&#34;https://www.youtube.com/watch?v=xJi6pldZnsw&#34;</span>
</span></span></code></pre></div><p>And voila, I have the stats for the YouTube videos I&rsquo;m interested in!</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/calculating-your-potential-reach-on-mastodon-with-google-cloud-workflows-orchestrating-the-mastodon-apis/>Calculating your potential reach on Mastodon with Google Cloud Workflows orchestrating the Mastodon APIs</a></li><li><a href=/posts/turning-a-website-into-a-desktop-application/>Turning a Website Into a Desktop Application</a></li><li><a href=/posts/apis-we-have-a-problem-json/>APIs, we have a Problem JSON</a></li><li><a href=/posts/workflows-tips-and-tricks/>Workflows Tips and Tricks</a></li><li><a href=/posts/retrieve-youtube-views-count-with-youtubedl-jq-and-a-docker-container/>Retrieve YouTube views count with youtubeDL, JQ, and a Docker container</a></li></ul></div></div></aside><footer><div class=social><a href=https://uwyn.net/@glaforge><img src=/img/icons/mastodon-black.svg alt="Mastodon logo" width=42px></a>
<a href=https://twitter.com/@glaforge><img src=/img/icons/twitter-black.svg alt="Twitter logo" width=50px></a>
<a href=https://github.com/glaforge><img src=/img/icons/github-black.svg alt="Github logo" width=45px></a>
<a href=https://linkedin.com/in/glaforge><img src=/img/icons/linkedin-black.svg alt="LinkedIn logo" width=43px></a>
<a href=https://speakerdeck.com/glaforge><img src=/img/icons/speakerdeck-black.svg alt="SpeakerDeck logo" width=60px></a></div><p>&copy; 2023 <a href=/about>Guillaume Laforge</a></p></footer></body></html>