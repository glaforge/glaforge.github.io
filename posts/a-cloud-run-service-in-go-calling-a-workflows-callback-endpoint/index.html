<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>A Cloud Run service in Go calling a Workflows callback endpoint</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Slab:wght@800&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/comic-mono@0.0.1/index.css rel=stylesheet><link rel=stylesheet href=/css/style.css></head><body><header><div><a href=https://glaforge.github.io/>‚ùØ Guillaume Laforge</a><nav><ul><li><a href=/>BLOG</a></li><li><a href=/talks>TALKS</a></li><li><a href=/about>ABOUT</a></li><li><a href=/contact>CONTACT</a></li></ul></nav></div></header><main><article><h1>A Cloud Run service in Go calling a Workflows callback endpoint</h1><time datetime=2022-09-27T16:02:00>üìÖ 2022-09-27 üïë 16:02</time><div class=author>üñã by Guillaume Laforge</div><div class=tags><a href=/tags/cloud-run>cloud-run</a>
<a href=/tags/google-cloud>google-cloud</a>
<a href=/tags/workflows>workflows</a>
<a href=/tags/go>go</a></div><div><p>It&rsquo;s all <a href=https://seroter.com/>Richard Seroter</a>&rsquo;s fault, I ended up dabbling with <a href=https://go.dev/>Golang</a>!
We were chatting about a use case using Google Cloud <a href=https://cloud.google.com/workflows>Workflows</a> and a <a href=https://cloud.run/>Cloud Run</a> service implemented in Go.
So it was the occasion to play a bit with Go. Well, I still don&rsquo;t like error handling&mldr; But let&rsquo;s rewind the story a bit!</p><p>Workflows is a fully-managed service/API orchestrator on Google Cloud. You can create some advanced business workflows using YAML syntax.
I&rsquo;ve built numerous little projects using it, and <a href=https://cloud.google.com/blog/topics/developers-practitioners/introducing-workflows-callbacks>blogged</a> about it.
I particularly like its ability to pause a workflow execution, creating a <a href=https://cloud.google.com/workflows/docs/creating-callback-endpoints>callback endpoint</a>
that you can call from an external system to resume the execution of the workflow.
With callbacks, you&rsquo;re able to implement human validation steps, for example in an expense report application
where a manager validates or rejects an expense from someone in their team (this is what I implemented in this
<a href=https://cloud.google.com/blog/topics/developers-practitioners/smarter-applications-document-ai-workflows-and-cloud-functions>article</a>).</p><p>For my use case with Richard, we had a workflow that was creating such a callback endpoint.
This endpoint is called from a Cloud Run service implemented in Go.
Let&rsquo;s see how to implement the workflow:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#062873;font-weight:700>main</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>¬†¬†¬†¬†params</span>:<span style=color:#bbb> </span>[input]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>¬†¬†¬†¬†steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#062873;font-weight:700>create_callback</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>call</span>:<span style=color:#bbb> </span>events.create_callback_endpoint<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#062873;font-weight:700>http_callback_method</span>:<span style=color:#bbb> </span><span style=color:#4070a0>&#34;POST&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>result</span>:<span style=color:#bbb> </span>callback_details<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#062873;font-weight:700>log_callback_creation</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>call</span>:<span style=color:#bbb> </span>sys.log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#062873;font-weight:700>text</span>:<span style=color:#bbb> </span>${&#34;Callback created, awaiting calls on &#34; + callback_details.url}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#062873;font-weight:700>await_callback</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>call</span>:<span style=color:#bbb> </span>events.await_callback<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#062873;font-weight:700>callback</span>:<span style=color:#bbb> </span>${callback_details}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#062873;font-weight:700>timeout</span>:<span style=color:#bbb> </span><span style=color:#40a070>86400</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>result</span>:<span style=color:#bbb> </span>callback_request<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#062873;font-weight:700>log_callback_received</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>call</span>:<span style=color:#bbb> </span>sys.log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#062873;font-weight:700>json</span>:<span style=color:#bbb> </span>${callback_request.http_request}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#062873;font-weight:700>return_callback_request</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#062873;font-weight:700>return</span>:<span style=color:#bbb> </span>${callback_request.http_request}<span style=color:#bbb>
</span></span></span></code></pre></div><p>The above workflow definition creates a callback endpoint. The URL of the callback endpoint is returned by that first step.
Then the workflow is waiting for the callback endpoint to be called externally.
The execution then resumes and logs some info about the incoming call and returns.</p><p>I deployed that workflow with a service account that has the Workflows Editor role, the Log Writer role (to log information),
and the Service Account Token Creator role (to create OAuth2 tokens),
as <a href=https://cloud.google.com/workflows/docs/creating-callback-endpoints#oauth-token>explained</a> in the documentation.</p><p>Now let&rsquo;s look at the Go service. I did a go mod init to create a new project.
I created a main.go source file with the following content:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#007020;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	metadata <span style=color:#4070a0>&#34;cloud.google.com/go/compute/metadata&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4070a0>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>The metadata module is used to fetch an OAuth2 token from the <a href=https://cloud.google.com/run/docs/container-contract#metadata-server>Cloud Run metadata server</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// OAuth2 JSON struct
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>type</span> OAuth2TokenInfo <span style=color:#007020;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>// defining struct variables
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>	Token<span>¬†</span> <span>¬†</span> <span>¬†</span> <span style=color:#902000>string</span> <span style=color:#4070a0>`json:&#34;access_token&#34;`</span>
</span></span><span style=display:flex><span>	TokenType<span>¬†</span> <span style=color:#902000>string</span> <span style=color:#4070a0>`json:&#34;token_type&#34;`</span>
</span></span><span style=display:flex><span>	Expiration <span style=color:#902000>uint32</span> <span style=color:#4070a0>`json:&#34;expires_in&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The metadata information in <code>instance/service-accounts/default/token</code> returns a JSON document that we map with the above struct.
We&rsquo;re interested in the access_token field, that we use further down to make the authenticated call to the Workflows callback endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#007020;font-weight:700>func</span> <span style=color:#06287e>main</span>() {
</span></span><span style=display:flex><span>	log.<span style=color:#06287e>Print</span>(<span style=color:#4070a0>&#34;Starting server...&#34;</span>)
</span></span><span style=display:flex><span>	http.<span style=color:#06287e>HandleFunc</span>(<span style=color:#4070a0>&#34;/&#34;</span>, handler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>// Determine port for HTTP service.	port := os.Getenv(&#34;PORT&#34;)	
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>if</span> port <span style=color:#666>==</span> <span style=color:#4070a0>&#34;&#34;</span> {		
</span></span><span style=display:flex><span>        port = <span style=color:#4070a0>&#34;8080&#34;</span>		
</span></span><span style=display:flex><span>        log.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;Defaulting to port %s&#34;</span>, port)	
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>// Start HTTP server.	
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    log.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;Listening on port %s&#34;</span>, port)	
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> err <span style=color:#666>:=</span> http.<span style=color:#06287e>ListenAndServe</span>(<span style=color:#4070a0>&#34;:&#34;</span><span style=color:#666>+</span>port, <span style=color:#007020;font-weight:700>nil</span>); err <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {		
</span></span><span style=display:flex><span>        log.<span style=color:#06287e>Fatal</span>(err)	
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>main()</code> function starts our Go service. Let&rsquo;s now see the <code>handler()</code> function in more detail:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#007020;font-weight:700>func</span> <span style=color:#06287e>handler</span>(w http.ResponseWriter, r <span style=color:#666>*</span>http.Request) {
</span></span><span style=display:flex><span>	callbackUrl <span style=color:#666>:=</span> r.URL.<span style=color:#06287e>Query</span>().<span style=color:#06287e>Get</span>(<span style=color:#4070a0>&#34;callback_url&#34;</span>)
</span></span><span style=display:flex><span>	log.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;Callback URL: %s&#34;</span>, callbackUrl)
</span></span></code></pre></div><p>We retrieve the <code>?callback_url</code> query parameter that will contain our callback endpoint URL.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>// Fetch an OAuth2 access token from the metadata server
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>	oauthToken, errAuth <span style=color:#666>:=</span> metadata.<span style=color:#06287e>Get</span>(<span style=color:#4070a0>&#34;instance/service-accounts/default/token&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> errAuth <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#06287e>Fatal</span>(errAuth)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>Above, we make a call to the metadata server thanks to the metadata Go module.
And then we unmarshall the returned JSON document in our previously defined struct, with the following code:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	data <span style=color:#666>:=</span> OAuth2TokenInfo{}
</span></span><span style=display:flex><span>	errJson <span style=color:#666>:=</span> json.<span style=color:#06287e>Unmarshal</span>([]<span style=color:#007020>byte</span>(oauthToken), <span style=color:#666>&amp;</span>data)
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> errJson <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		fmt.<span style=color:#06287e>Println</span>(errJson.<span style=color:#06287e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	log.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;OAuth2 token: %s&#34;</span>, data.Token)
</span></span></code></pre></div><p>Now it&rsquo;s time to prepare the call to our workflow callback endpoint, with a POST request:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	workflowReq, errWorkflowReq <span style=color:#666>:=</span> http.<span style=color:#06287e>NewRequest</span>(<span style=color:#4070a0>&#34;POST&#34;</span>, callbackUrl, strings.<span style=color:#06287e>NewReader</span>(<span style=color:#4070a0>&#34;{}&#34;</span>))
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> errWorkflowReq <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		fmt.<span style=color:#06287e>Println</span>(errWorkflowReq.<span style=color:#06287e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>We add the OAuth2 token as a bearer authorization via headers:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	workflowReq.Header.<span style=color:#06287e>Add</span>(<span style=color:#4070a0>&#34;authorization&#34;</span>, <span style=color:#4070a0>&#34;Bearer &#34;</span><span style=color:#666>+</span>data.Token)
</span></span><span style=display:flex><span>	workflowReq.Header.<span style=color:#06287e>Add</span>(<span style=color:#4070a0>&#34;accept&#34;</span>, <span style=color:#4070a0>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>	workflowReq.Header.<span style=color:#06287e>Add</span>(<span style=color:#4070a0>&#34;content-type&#34;</span>, <span style=color:#4070a0>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client <span style=color:#666>:=</span> <span style=color:#666>&amp;</span>http.Client{}	
</span></span><span style=display:flex><span>    workflowResp, workflowErr <span style=color:#666>:=</span> client.<span style=color:#06287e>Do</span>(workflowReq)	
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> workflowErr <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>        fmt.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;Error making callback request: %s\n&#34;</span>, workflowErr)	
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    log.<span style=color:#06287e>Printf</span>(<span style=color:#4070a0>&#34;Status code: %d&#34;</span>, workflowResp.StatusCode)
</span></span><span style=display:flex><span>	fmt.<span style=color:#06287e>Fprintf</span>(w, <span style=color:#4070a0>&#34;Workflow callback called. Status code: %d&#34;</span>, workflowResp.StatusCode)}
</span></span></code></pre></div><p>We simply return the status code at the end of our Go service.</p><p>To deploy the Go service, I simply used the source deployment approach, by running gcloud run deploy,
and answering some questions (service name, region deployment, etc.)
After a couple of minutes, the service is up and running.</p><p>I create a new execution of the workflow from the Google Cloud console.
Once it&rsquo;s started, it logs the callback endpoint URL.
I copy its value, then I&rsquo;m calling my Cloud Run service with the <code>?callback_url=</code> query string pointing at that URL.
And voil√†, the service resumes the execution of the workflow, and the workflow finishes.</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/calculating-your-potential-reach-on-mastodon-with-google-cloud-workflows-orchestrating-the-mastodon-apis/>Calculating your potential reach on Mastodon with Google Cloud Workflows orchestrating the Mastodon APIs</a></li><li><a href=/posts/turning-a-website-into-a-desktop-application/>Turning a Website Into a Desktop Application</a></li><li><a href=/posts/apis-we-have-a-problem-json/>APIs, we have a Problem JSON</a></li><li><a href=/posts/workflows-tips-and-tricks/>Workflows Tips and Tricks</a></li><li><a href=/posts/retrieve-youtube-views-count-with-youtubedl-jq-and-a-docker-container/>Retrieve YouTube views count with youtubeDL, JQ, and a Docker container</a></li></ul></div></div></aside><footer><div class=social><a href=https://uwyn.net/@glaforge><img src=/img/icons/mastodon-black.svg alt="Mastodon logo" width=42px></a>
<a href=https://twitter.com/@glaforge><img src=/img/icons/twitter-black.svg alt="Twitter logo" width=50px></a>
<a href=https://github.com/glaforge><img src=/img/icons/github-black.svg alt="Github logo" width=45px></a>
<a href=https://linkedin.com/in/glaforge><img src=/img/icons/linkedin-black.svg alt="LinkedIn logo" width=43px></a>
<a href=https://speakerdeck.com/glaforge><img src=/img/icons/speakerdeck-black.svg alt="SpeakerDeck logo" width=60px></a></div><p>&copy; 2023 <a href=/about>Guillaume Laforge</a></p></footer></body></html>