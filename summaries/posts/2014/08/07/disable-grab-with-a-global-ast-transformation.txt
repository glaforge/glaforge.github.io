This article details a solution for disabling Groovy's `@Grab` and `@Grapes` annotations, which are used to dynamically download third-party dependencies. The motivation stems from a common concern raised on the Groovy mailing list: preventing users from introducing unauthorized or untrusted libraries into a project, thereby enhancing control over dependencies and potentially improving security and build stability. The author proposes a robust approach using a global Groovy AST (Abstract Syntax Tree) transformation.

Initially, the author experimented with a local AST transformation within a script. However, to create a truly enforceable and universally applicable solution, a dedicated project implementing a *global* AST transformation was developed. This project is hosted on GitHub and can be cloned and tested to see the transformation in action.

The core of the solution is the `DisableGrabTransformation` class. This class implements the `groovy.transform.ASTTransformation` interface and is configured to execute during the `CompilePhase.CANONICALIZATION`, an early stage in the Groovy compilation process. Its `visit` method is central to the logic:
1.  It accesses the `imports` of the `SourceUnit` (which represents the Groovy script or class being compiled).
2.  It iterates through each import statement found in the source code.
3.  For each import, it checks if any annotations are present.
4.  Crucially, it specifically looks for annotations with the fully qualified class names `'groovy.lang.Grab'` or `'groovy.lang.Grapes'`.
5.  If either of these forbidden annotations is detected on an import statement, the transformation immediately adds a `SyntaxErrorMessage` to the `source.errorCollector`. This action triggers a compilation error with a custom message: "@Grab and @Grapes are forbidden," effectively halting the compilation process and preventing the offending code from being built successfully.

To ensure this transformation is applied globally to all Groovy scripts and classes compiled within its scope, it must be registered using a specific service loader mechanism. Unlike local transformations that are triggered by an annotation directly on the code, global transformations are discovered by the compiler if a specific file exists on the classpath. This involves creating a file named `META-INF/services/org.codehaus.groovy.transform.ASTTransformation`, which contains a single line: the fully qualified class name of the transformation, in this case, `disablegrab.DisableGrabTransformation`.

The article includes a Spock test (`DisableGrabSpec`) to demonstrate and verify the transformation's functionality. This test uses a `GroovyShell` to programmatically evaluate a Groovy script snippet that intentionally includes a `@Grab` annotation. The test then asserts that this compilation attempt correctly throws a `MultipleCompilationErrorsException` and confirms that the exception's message contains the expected custom error string "@Grab and @Grapes are forbidden". This provides concrete proof that the transformation is active and successfully preventing the use of `@Grab`.

The Gradle build file for the project is straightforward, applying the `groovy` plugin and using `jcenter()` as a repository. Key dependencies include `groovy-all`, `spock-core` for testing, and `org.apache.ivy:ivy`. The `ivy` dependency is included because it's required by the underlying Grape infrastructure for its full functionality, even though the goal is to disable Grape's direct use via annotations.

The conclusion is that once this project is built into a JAR file using the `jar` Gradle task, simply placing this JAR on the compilation classpath will activate the global AST transformation. Any Groovy script or class subsequently compiled with this JAR on its classpath will then fail compilation if it attempts to use the `@Grab` or `@Grapes` annotations, thereby enforcing the desired restriction on dependency downloading.